---
import { ViewTransitions } from "astro:transitions";

import "../styles/fonts.css";
import "../styles/global.css";
import Header from "../components/Header.astro";
import ServicesHeader from "../components/ServicesHeader.astro";
import Footer from "../components/Footer.astro";
import MobileStickyCTA from "../components/MobileStickyCTA.astro";
import SmoothScroll from "../components/SmoothScroll.astro";
import type { BrandConfig } from "../brands";
import { mobileTiresBrand } from "../brands";

const {
  title = "Queens Mobile Tires",
  description = "We come to you.",
  brand: propBrand,
  headerInverse = false,
} = Astro.props;

// Use provided brand or default to mobile tires brand
const brand: BrandConfig = propBrand || mobileTiresBrand;

const currentPath = Astro.url.pathname;
// Check if we are on a service SUB-PAGE (e.g. /services/brakes)
// We want to exclude the main archive page (/services) which needs the white header.
const isServicesArchive =
  currentPath === "/services" || currentPath === "/services/";
const isServiceSubPage =
  currentPath.startsWith("/services") && !isServicesArchive;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/png" href="/favicon.png" />

    <!-- Critical Font Preloads - Load these before CSS parsing -->
    <link
      rel="preload"
      href="/fonts/BigShoulders-VariableFont.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/InstrumentSans-Regular.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />

    <!-- Preconnect to external video host for Hero video -->
    <link rel="dns-prefetch" href="https://storage.googleapis.com" />
    <link rel="preconnect" href="https://storage.googleapis.com" crossorigin />

    <title>{title}</title>
    <ViewTransitions />
    <script is:inline>
      const applyTheme = () => {
        if (
          localStorage.getItem("color-theme") === "dark" ||
          (!("color-theme" in localStorage) &&
            window.matchMedia("(prefers-color-scheme: dark)").matches)
        ) {
          document.documentElement.classList.add("dark");
        } else {
          document.documentElement.classList.remove("dark");
        }
      };

      // Apply on initial load
      applyTheme();

      // Re-apply after View Transitions swap
      document.addEventListener("astro:after-swap", applyTheme);
    </script>

    <!-- Always start fresh from top on page load -->
    <script is:inline>
      // Disable browser's automatic scroll restoration - always start at top
      if ("scrollRestoration" in history) {
        history.scrollRestoration = "manual";
      }
      // Scroll to top immediately
      window.scrollTo(0, 0);
    </script>
    <slot name="head" />
  </head>
  <body
    class="bg-page text-queens-primary flex flex-col min-h-screen w-full overflow-x-hidden dark:text-gray-100"
  >
    <a href="#main-content" class="skip-to-content-link">Skip to main content</a
    >

    {
      isServiceSubPage ? (
        <ServicesHeader brand={brand} inverse={headerInverse} />
      ) : (
        <Header brand={brand} inverse={headerInverse} />
      )
    }

    <main id="main-content" class="flex-grow">
      <slot />
    </main>

    <Footer brand={brand} />
    <SmoothScroll />
    {/* <MobileStickyCTA brand={brand} /> */}

    <!-- Global video autoplay fallback for Edge/browser compatibility -->
    <script is:inline>
      function forceAllVideosToPlay() {
        document.querySelectorAll("video").forEach(function (video) {
          if (video.paused && video.muted) {
            video.play().catch(function () {
              // Silent fail - browser policy blocks autoplay
            });
          }
        });
      }

      // Run on initial load
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", forceAllVideosToPlay);
      } else {
        forceAllVideosToPlay();
      }

      // Run after Astro view transitions
      document.addEventListener("astro:page-load", forceAllVideosToPlay);

      // Also run after a short delay in case videos load late
      setTimeout(forceAllVideosToPlay, 500);
    </script>
  </body>
</html>
