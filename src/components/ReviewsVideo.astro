---
/**
 * ReviewsVideo - Video testimonial section with auto-looping review cards
 * Features: Video on left, 2 review cards that auto-loop on right
 */

const reviews = [
    {
        name: "Luis Subias",
        role: "Verified Customer",
        stars: 5,
        text: "Came in to patch up a flat tire with a nail. They took me in as a walk in and fixed it super fast. Exceptional customer service!",
        rating: "5/5",
    },
    {
        name: "Mike Abene III",
        role: "Verified Customer",
        stars: 5,
        text: "Brought my 30ft RV to have 6 tires mounted... Great hospitable group of people working there from top to bottom.",
        rating: "5/5",
    },
];

// Helper to get initials
const getInitials = (name: string) => {
    return name
        .split(" ")
        .map((word) => word[0])
        .join("")
        .substring(0, 2)
        .toUpperCase();
};

// We need 3x for seamless looping
const allReviews = [...reviews, ...reviews, ...reviews];
const reviewCount = reviews.length;
---

<section class="reviews-video-section" data-review-count={reviewCount}>
    <div class="reviews-container">
        <!-- Header -->
        <div class="reviews-header">
            <h2 class="reviews-title">
                Words from our <span class="title-accent">clients</span>
            </h2>
            <p class="reviews-subtitle">
                Real reviews from real customers. Our commitment to quality
                service has earned us the trust of drivers across Northern
                Illinois.
            </p>
        </div>

        <!-- Content Grid -->
        <div class="reviews-grid">
            <!-- Left: Video Card -->
            <div class="video-card">
                <video autoplay muted loop playsinline class="review-video">
                    <source
                        src="/video/Queens Auto Testimonial - Video.mp4"
                        type="video/mp4"
                    />
                </video>
                <div class="video-overlay">
                    <div class="video-stars">★★★★★</div>
                    <div class="video-rating">5/5</div>
                </div>
                <div class="video-info">
                    <div class="video-name">Queens Auto Customer</div>
                    <div class="video-role">Video Testimonial</div>
                </div>
            </div>

            <!-- Right: Review Cards (looping) -->
            <div class="review-cards-wrapper" id="review-cards-wrapper">
                <div class="review-cards-track" id="review-cards-track">
                    {
                        allReviews.map((review, index) => (
                            <div class="review-card" data-index={index}>
                                <div class="review-stars">
                                    {Array.from({ length: review.stars }).map(
                                        () => (
                                            <span class="star">★</span>
                                        ),
                                    )}
                                </div>
                                <blockquote class="review-text">
                                    "{review.text}"
                                </blockquote>
                                <div class="review-author">
                                    <div class="author-avatar">
                                        {getInitials(review.name)}
                                    </div>
                                    <div class="author-info">
                                        <div class="author-name">
                                            {review.name}
                                        </div>
                                        <div class="author-role">
                                            {review.role}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))
                    }
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    .reviews-video-section {
        --section-bg: #f5f5f5;
        --card-bg: #ffffff;
        --card-border: rgba(0, 0, 0, 0.06);
        --text-primary: #0f172a;
        --text-secondary: #64748b;
        --star-color: #f59e0b;
        --accent: #0a79c8;

        background: var(--section-bg);
        padding: 6rem 1.5rem 4rem;
        overflow: hidden;
        position: relative;
    }

    :global(.dark) .reviews-video-section {
        --section-bg: #0a0a0b;
        --card-bg: rgba(255, 255, 255, 0.03);
        --card-border: rgba(255, 255, 255, 0.08);
        --text-primary: #f8fafc;
        --text-secondary: #94a3b8;
        --accent: #22d3ee;
    }

    .reviews-container {
        max-width: 1280px;
        margin: 0 auto;
        position: relative;
        z-index: 1;
    }

    /* Header */
    .reviews-header {
        text-align: center;
        margin-bottom: 4rem;
    }

    .reviews-title {
        font-size: clamp(2rem, 4vw + 0.5rem, 3rem);
        font-weight: 700;
        color: var(--text-primary);
        margin: 0 0 1rem;
        letter-spacing: -0.02em;
    }

    .title-accent {
        font-style: italic;
        font-weight: 400;
    }

    .reviews-subtitle {
        font-size: 1.0625rem;
        color: var(--text-secondary);
        max-width: 600px;
        margin: 0 auto;
        line-height: 1.7;
    }

    /* Grid */
    .reviews-grid {
        display: grid;
        grid-template-columns: 1fr 1.5fr;
        gap: 2rem;
        align-items: start;
    }

    /* Video Card */
    .video-card {
        position: relative;
        border-radius: 1.5rem;
        overflow: hidden;
        aspect-ratio: 3 / 4;
        background: #000;
    }

    .review-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .video-overlay {
        position: absolute;
        top: 1.5rem;
        left: 1.5rem;
        right: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .video-stars {
        color: var(--star-color);
        font-size: 1rem;
        letter-spacing: 2px;
    }

    .video-rating {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(8px);
        color: white;
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.375rem 0.75rem;
        border-radius: 100px;
    }

    .video-info {
        position: absolute;
        bottom: 1.5rem;
        left: 1.5rem;
        color: white;
    }

    .video-name {
        font-size: 1.125rem;
        font-weight: 600;
    }

    .video-role {
        font-size: 0.875rem;
        opacity: 0.8;
    }

    /* Review Cards - Fixed height container */
    .review-cards-wrapper {
        overflow: hidden;
        position: relative;
        height: 500px; /* Default fallback height, will be set by JS */
    }

    .review-cards-track {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        will-change: transform;
    }

    .review-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 1.25rem;
        padding: 2rem;
        flex-shrink: 0;
    }

    .review-stars {
        display: flex;
        gap: 0.25rem;
        margin-bottom: 1rem;
    }

    .star {
        color: var(--star-color);
        font-size: 1.125rem;
    }

    .review-text {
        font-size: 1rem;
        color: var(--text-primary);
        line-height: 1.7;
        margin: 0 0 1.5rem;
        font-weight: 400;
    }

    .review-author {
        display: flex;
        align-items: center;
        gap: 0.875rem;
    }

    .author-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--accent), #3b82f6);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .author-name {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.9375rem;
    }

    .author-role {
        font-size: 0.8125rem;
        color: var(--text-secondary);
    }

    /* Responsive */
    @media (max-width: 900px) {
        .reviews-grid {
            grid-template-columns: 1fr;
        }

        .video-card {
            aspect-ratio: 1 / 1;
            max-width: 400px;
            margin: 0 auto;
        }

        .review-cards-wrapper {
            height: auto !important;
            overflow: visible;
        }

        .review-cards-track {
            position: static;
            transform: none !important;
        }
    }
</style>

<script>
    import gsap from "gsap";

    let animation: gsap.core.Tween | null = null;

    function initReviewAnimation() {
        // Kill any existing animation
        if (animation) {
            animation.kill();
            animation = null;
        }

        // Skip on mobile
        if (window.innerWidth <= 900) return;

        const section = document.querySelector(".reviews-video-section");
        const wrapper = document.getElementById("review-cards-wrapper");
        const track = document.getElementById("review-cards-track");

        if (!section || !wrapper || !track) return;

        // Get the review count from the data attribute
        const reviewCount = parseInt(
            section.getAttribute("data-review-count") || "2",
            10,
        );

        // Get all review cards
        const cards = track.querySelectorAll(".review-card");
        if (cards.length === 0) return;

        // Calculate dimensions
        const firstCard = cards[0] as HTMLElement;
        const cardHeight = firstCard.offsetHeight;
        const gap = parseFloat(getComputedStyle(track).gap) || 24;

        // Height of one set of original reviews
        const singleSetHeight =
            cardHeight * reviewCount + gap * (reviewCount - 1);

        // Set wrapper height to show one set
        wrapper.style.height = `${singleSetHeight}px`;

        // Create infinite scrolling animation
        animation = gsap.to(track, {
            y: -(singleSetHeight + gap),
            duration: 15,
            ease: "none",
            repeat: -1,
            modifiers: {
                y: gsap.utils.unitize(
                    gsap.utils.wrap(0, -(singleSetHeight + gap)),
                ),
            },
        });

        // Pause on hover
        wrapper.addEventListener("mouseenter", () => {
            if (animation) animation.pause();
        });

        wrapper.addEventListener("mouseleave", () => {
            if (animation) animation.resume();
        });
    }

    // Initialize on page load
    document.addEventListener("astro:page-load", initReviewAnimation);

    // Also initialize on DOMContentLoaded for initial page load
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initReviewAnimation);
    } else {
        // DOM is already ready
        initReviewAnimation();
    }

    // Cleanup before page swap
    document.addEventListener("astro:before-swap", () => {
        if (animation) {
            animation.kill();
            animation = null;
        }
    });

    // Re-initialize on resize
    let resizeTimeout: ReturnType<typeof setTimeout>;
    window.addEventListener("resize", () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(initReviewAnimation, 250);
    });
</script>
