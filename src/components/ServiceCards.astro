---
const services = [
  {
    title: "Price Per Axle",
    subtitle: "$369 BRAKE SPECIAL",
    image: "/images/services/Changing brakes.webp",
    alt: "Professional Brake System Service",
    accent: "text-queens-secondary",
    link: "https://queensautoserviceselgin.com/brakes/booking.htm"
  },
  {
    title: "Limited Time Offer",
    subtitle: "$35 OFF ALIGNMENT",
    image: "/images/services/Wheel-Alignment-Elgin-001.webp",
    alt: "Wheel Alignment Special Offer",
    accent: "text-queens-secondary",
    link: "https://queensautoserviceselgin.com/wheel-alignment/special-offer.htm"
  },
  {
    title: "General Repair",
    subtitle: "$100 OFF SERVICES",
    image: "/images/services/Queens-Auto-Services-Auto-Repair-Slider-007.webp",
    alt: "General Repair Discount",
    accent: "text-queens-secondary",
    link: "https://offer.queensautoserviceselgin.com/?_gl=1*jhv8ad*_gcl_au*MTYwNzA5ODA5NS4xNzY1ODUyMjM2LjM4NTA0NDcxNC4xNzY1ODUyMjQwLjE3NjU4NTIyNDA."
  }
];
---

<section id="homepage-deals" class="py-20 overflow-hidden">
  <div class="site-canvas">
    <!-- Header -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 mb-16 items-start">
      <h2 class="display-xl text-queens-primary dark:text-white">
        EXCLUSIVE <br/>
        <span class="text-queens-secondary">SPECIALS</span>
      </h2>
      <p class="text-gray-600 dark:text-gray-400 text-lg leading-relaxed max-w-xl">
        Take advantage of our limited-time offers! From brake specials to discounts on general repairs, 
        we have the best deals to keep your vehicle running smoothly for less. 
        Claim your offer today!
      </p>
    </div>

    <!-- Cards Grid (BEM Structured via Tailwind utility composition/classes) -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
      {services.map((service) => (
        <a 
          href={service.link}
          class="special-card group relative aspect-[3/4] rounded-3xl overflow-hidden cursor-pointer block"
        >
          <!-- Background Image -->
          <img 
            src={service.image} 
            alt={service.alt}
            class="special-card__image absolute inset-0 w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
          />
          
          <!-- Gradient Overlay -->
          <div class="special-card__overlay absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent opacity-80 group-hover:opacity-90 transition-opacity duration-500"></div>

          <!-- Content -->
          <div class="special-card__content absolute bottom-0 left-0 p-8 w-full">
            <span 
              class={`special-card__subtitle font-serif italic text-3xl ${service.accent} mb-2 block`}
              style="font-family: var(--font-serif);"
            >
              {service.title}
            </span>
            <h3 class="special-card__title display-md text-white group-hover:-translate-y-2 transition-transform duration-500">
              {service.subtitle}
            </h3>
          </div>
        </a>
      ))}
    </div>
  </div>
</section>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  // Ensure ScrollTrigger is registered only once per page cycle
  gsap.registerPlugin(ScrollTrigger);

  let serviceCardsCtx: any = null;

  function initServiceCardsAnimations() {
    // Revert existing animations if they exist (crucial for View Transitions)
    if (serviceCardsCtx) serviceCardsCtx.revert();

    // Create a scoped GSAP context
    serviceCardsCtx = gsap.context(() => {
      const section = document.querySelector("#homepage-deals");
      if (!section) return;

      // Header Animation
      const header = section.querySelector(".grid");
      if (header) {
        gsap.fromTo(header.children, 
          { y: 30, opacity: 0 },
          {
            y: 0,
            opacity: 1,
            duration: 1,
            stagger: 0.1,
            ease: "power3.out",
            scrollTrigger: {
              trigger: header,
              start: "top 95%",
              once: true
            }
          }
        );
      }

      const cards = section.querySelectorAll(".special-card");
      cards.forEach((card, index) => {
        let xOffset = 0;
        let yOffset = 0;

        if (index === 0) xOffset = -50;
        else if (index === 1) yOffset = 50;
        else if (index === 2) xOffset = 50;

        gsap.fromTo(card,
          { x: xOffset, y: yOffset, opacity: 0, scale: 0.95 },
          {
            x: 0,
            y: 0,
            opacity: 1,
            scale: 1,
            duration: 1.2,
            ease: "power3.out",
            scrollTrigger: {
              trigger: card,
              start: "top 95%",
              once: true
            }
          }
        );
      });
    });
  }

  // Handle both initial load and subsequent navigations
  document.addEventListener("astro:page-load", () => {
    // Small timeout to allow other pinned sections (like GSAPNewTires) 
    // to calculate their heights first, avoiding layout shifts
    setTimeout(initServiceCardsAnimations, 250);
  });

  // Ensure cleanup when leaving the page
  document.addEventListener("astro:before-swap", () => {
    if (serviceCardsCtx) serviceCardsCtx.revert();
  });
</script>


