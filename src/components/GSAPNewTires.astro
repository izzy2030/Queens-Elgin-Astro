---
/**
 * GSAPNewTires - GSAP New Tires Section
 * Section pins to viewport, scroll drives animations, then unpins.
 */
---

<div class="scroll-promo" id="scroll-promo">
    <!-- Main Pinned Section -->
    <section class="promo-section promo-section--main" data-section="main">
        <!--
Video Background -->
        <video
            autoplay
            loop
            muted
            playsinline
            style="background-color: #000;"
            class="promo-video"
        >
            <source src="/video/queens-elgin-intro.mp4" type="video/mp4" />
            Your browser does not support the video tag.
        </video>
        <!-- Content
wrapper -->
        <div class="promo-content">
            <!-- Headline 1: Tire Sale -->
            <h2 class="promo-text promo-text--1">
                <span class="promo-text__tag">Limited Time</span>
                <span class="promo-text__main">Tire Sale</span>
            </h2>
            <!-- Headline
2: Free Alignment Offer -->
            <h3 class="promo-text promo-text--2">
                Buy 4 Tires.<br />Free Alignment.
            </h3>
            <!-- Text Reveal -->
            <p class="promo-text
promo-text--3">
                <span>Shop top brands online.</span>
                <span>&nbsp;Professional in-shop installation.</span>
                <span>&nbsp;Purchase a full set of 4.</span>
                <span>&nbsp;And get a FREE alignment.</span>
            </p>
        </div>
    </section>
    <!-- CTA
Section (separate, not pinned) -->
    <section class="promo-section
promo-section--cta" data-section="cta">
        <div class="promo-cta">
            <span class="promo-cta__label">Claim your offer?</span>
            <a href="/buy-new-tires" class="promo-cta__button"
                >Shop Tires & Save</a
            >
        </div>
    </section>
</div>
<style>
    /* Main Container */
    .scroll-promo {
        background: #141517;
        color: #f9fafb;
        position: relative;
    } /* Main section - will be pinned */
    .promo-section--main {
        position: relative;
        width: 100%;
        height: 100vh;
        overflow: hidden;
    }
    .promo-section--cta {
        position: relative;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
    } /* Video Background */
    .promo-video {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 1;
        filter: saturate(0.2) brightness(0.35);
        opacity: 0;
    } /* Content container - centered */
    .promo-content {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2;
    } /* All text elements stacked in same position */
    .promo-text {
        position: absolute;
        text-align: center;
        margin: 0;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: -0.02em;
        transform-origin: center center;
        padding: 0 1.5rem;
        max-width: 100vw;
    } /* Headline 1 */
    .promo-text--1 {
        display: grid;
        font-size: clamp(3rem, 12vw + 1rem, 14rem);
        line-height: 0.85;
        gap: 0;
        will-change: transform, opacity;
    }
    .promo-text__tag {
        display: inline-block;
        color: hsl(200 100% 50%);
        font-size: 0.3em;
        margin-bottom: -0.2em;
        will-change: opacity;
    }
    .promo-text__main {
        display: inline-block;
        color: hsl(0 0% 40%);
        will-change: transform, color;
        transform: scale(0.5);
    } /* Headline 2 */
    .promo-text--2 {
        font-size: clamp(2rem, 7vw + 1rem, 6rem);
        line-height: 1.15;
        max-width: 900px;
        color: hsl(0 0% 40%);
        opacity: 0;
        transform: scale(0.6);
        text-transform: none;
        will-change: transform, opacity, color;
    } /* Text Reveal */
    .promo-text--3 {
        font-size: clamp(1.5rem, 4vw + 1rem, 4.5rem);
        letter-spacing: -0.01em;
        line-height: 1.25;
        font-weight: 600;
        max-width: 1000px;
        text-transform: none;
        opacity: 0;
        color: hsl(0 0% 100%);
    }
    .promo-text--3 span {
        opacity: 0.15;
        display: inline;
        color: hsl(0 0% 40%);
    } /*
CTA Section */
    .promo-cta {
        display: grid;
        place-items: center;
        gap: 2rem;
        text-align: center;
    }
    .promo-cta__label {
        font-size: clamp(2rem, 5vw + 1rem, 5rem);
        font-weight: 700;
        color: hsl(200 100% 60%);
    }
    .promo-cta__button {
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        background: hsl(200 100% 50%);
        color: white;
        font-weight: 600;
        padding: 1.25rem 3rem;
        border-radius: 100px;
        font-size: 1.5rem;
        text-decoration: none;
        transition: all 0.3s ease;
    }
    .promo-cta__button:hover {
        background: hsl(200 100% 60%);
        transform: scale(1.05);
    }
</style>
<script>
    import gsap from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";

    // Register globally once
    gsap.registerPlugin(ScrollTrigger);

    let ctx: any; // Using any to avoid type issues if GSAP types aren't perfectly inferred

    async function initScrollPromo() {
        const container = document.getElementById("scroll-promo");

        // If we navigated to a page without this component, clean up and exit
        if (!container) {
            if (ctx) ctx.revert();
            return;
        }

        // Clean up any existing context for this component
        if (ctx) ctx.revert();

        // Wait for next frame to ensure DOM layout is settled
        await new Promise(requestAnimationFrame);

        const video = container.querySelector(
            ".promo-video",
        ) as HTMLVideoElement;
        // Ensure video is playing if it was paused by navigation logic
        if (video) {
            video.play().catch(() => {
                /* Auto-play restrictions */
            });
        }

        // Create a new GSAP context scoped to the container
        ctx = gsap.context(() => {
            const mainSection = container.querySelector(
                '[data-section="main"]',
            );
            const text1 = container.querySelector(".promo-text--1");
            const textMain = container.querySelector(".promo-text__main");
            const textTag = container.querySelector(".promo-text__tag");
            const text2 = container.querySelector(".promo-text--2");
            const text3 = container.querySelector(".promo-text--3");
            const textSpans = container.querySelectorAll(".promo-text--3 span");

            if (!mainSection) return;

            // Create main timeline with PIN
            const masterTL = gsap.timeline({
                scrollTrigger: {
                    trigger: mainSection,
                    start: "top top",
                    end: "+=4000", // 4000px of scroll while pinned
                    pin: true,
                    scrub: 1, // Reduced scrub for snappier feel
                    anticipatePin: 1,
                    invalidateOnRefresh: true,
                },
            });

            // ==========================================
            // PHASE 1: Text 1 "Tire Sale"
            // ==========================================
            masterTL
                .fromTo(
                    textMain,
                    { scale: 0.5, color: "hsl(0, 0%, 40%)" },
                    {
                        scale: 1.3,
                        color: "hsl(0, 0%, 100%)",
                        duration: 1,
                        ease: "none",
                    },
                    0,
                )
                .to(
                    textTag,
                    { opacity: 0, duration: 0.5, ease: "power2.in" },
                    0.3,
                )
                .to(
                    text1,
                    {
                        opacity: 0,
                        scale: 1.5,
                        duration: 0.5,
                        ease: "power2.in",
                    },
                    1,
                )

                // ==========================================
                // PHASE 2: Text 2 "Premium Tires"
                // ==========================================
                .to(
                    text2,
                    {
                        opacity: 1,
                        duration: 0.2,
                        ease: "none",
                    },
                    1.6,
                )
                .fromTo(
                    text2,
                    { scale: 0.6, color: "hsl(0, 0%, 50%)" },
                    {
                        scale: 1,
                        color: "hsl(0, 0%, 100%)",
                        duration: 0.8,
                        ease: "none",
                    },
                    1.7,
                )
                .to(
                    text2,
                    { opacity: 0, scale: 1.1, duration: 0.5, ease: "none" },
                    2.6,
                )

                // ==========================================
                // PHASE 3: Video fades in
                // ==========================================
                .to(
                    video,
                    { opacity: 1, duration: 0.5, ease: "power2.out" },
                    2.8,
                )

                // ==========================================
                // PHASE 4: Text 3 reveal
                // ==========================================
                .to(
                    text3,
                    { opacity: 1, duration: 0.3, ease: "power2.out" },
                    3,
                );

            // Add span reveals
            if (textSpans.length) {
                textSpans.forEach((span, i) => {
                    masterTL.to(
                        span,
                        {
                            opacity: 1,
                            color: "hsl(0, 0%, 100%)",
                            duration: 0.4,
                            ease: "power2.inOut",
                        },
                        3.2 + i * 0.3,
                    );
                });
            }

            // Fade everything out at end
            masterTL
                .to(
                    text3,
                    { opacity: 0, duration: 0.3, ease: "power2.in" },
                    4.5,
                )
                .to(
                    video,
                    { opacity: 0, duration: 0.3, ease: "power2.in" },
                    4.5,
                );

            // ==========================================
            // CTA SECTION
            // ==========================================
            const ctaSection = container.querySelector('[data-section="cta"]');
            const ctaLabel = container.querySelector(".promo-cta__label");
            const ctaButton = container.querySelector(".promo-cta__button");

            if (ctaSection) {
                if (ctaLabel) {
                    gsap.from(ctaLabel, {
                        y: 50,
                        opacity: 0,
                        duration: 1,
                        ease: "power2.out",
                        scrollTrigger: {
                            trigger: ctaSection,
                            start: "top 80%",
                            end: "30% center",
                            scrub: 1,
                        },
                    });
                }

                if (ctaButton) {
                    gsap.from(ctaButton, {
                        y: 30,
                        opacity: 0,
                        duration: 1,
                        ease: "power2.out",
                        scrollTrigger: {
                            trigger: ctaSection,
                            start: "20% 80%",
                            end: "40% center",
                            scrub: 1,
                        },
                    });
                }
            }
        }, container); // Scope matches container

        // Refresh ScrollTrigger after a slight delay to account for any layout shifts
        setTimeout(() => ScrollTrigger.refresh(), 500);
    }

    // Initialize on page load (covers initial load and view transitions)
    document.addEventListener("astro:page-load", initScrollPromo);

    // Cleanup on component unmount/page swap
    document.addEventListener("astro:before-swap", () => {
        if (ctx) ctx.revert();
    });
</script>
