---
/**
 * ProcessSteps - Step-by-step workflow section
 * Left column and progress track stay sticky while right cards scroll
 */
import CtaButton from "./CtaButton.astro";
---

<section class="process-section" id="process-section">
    <div class="process-container">
        <!-- Left Column -->
        <div class="process-left">
            <h2 class="process-title display-lg">
                STEP BY <br />
                STEP <br />
                <span class="title-accent">WORKFLOW</span>
            </h2>
            <p class="process-subtitle">
                Streamlined auto repair process that's efficient, transparent,
                and tailored for your success.
            </p>
            <div class="process-cta-container">
                <CtaButton
                    href="/request-an-appointment"
                    text="Schedule Service"
                    variant="standard"
                />
            </div>
        </div>

        <!-- Middle: Progress Dots -->
        <div class="progress-track">
            <div class="progress-line">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-step active" data-step="1">
                <span class="step-dot">01</span>
            </div>
            <div class="progress-step" data-step="2">
                <span class="step-dot">02</span>
            </div>
            <div class="progress-step" data-step="3">
                <span class="step-dot">03</span>
            </div>
            <div class="progress-step" data-step="4">
                <span class="step-dot">04</span>
            </div>
        </div>

        <!-- Right Column: Cards -->
        <div class="process-right">
            <div class="step-card active" data-step="1">
                <span class="step-number">01</span>
                <h3 class="step-title">Schedule Your Service</h3>
                <p class="step-desc">
                    Book your appointment <span class="text-accent">online</span
                    > or give us a call. Choose the service you need and pick a time
                    that works for your schedule.
                    <span class="text-accent">Same-day appointments</span> often available.
                </p>
            </div>

            <div class="step-card" data-step="2">
                <span class="step-number">02</span>
                <h3 class="step-title">Vehicle Inspection</h3>
                <p class="step-desc">
                    Our <span class="text-accent">certified technicians</span> perform
                    a thorough diagnostic of your vehicle. We identify exactly what
                    needs attention and document everything with <span
                        class="text-accent">photos and video</span
                    >.
                </p>
            </div>

            <div class="step-card" data-step="3">
                <span class="step-number">03</span>
                <h3 class="step-title">Transparent Quote</h3>
                <p class="step-desc">
                    Receive a <span class="text-accent">detailed estimate</span> with
                    no hidden fees. We explain every repair, show you the parts needed,
                    and get your
                    <span class="text-accent"
                        >approval before any work begins</span
                    >.
                </p>
            </div>

            <div class="step-card" data-step="4">
                <span class="step-number">04</span>
                <h3 class="step-title">Expert Repair</h3>
                <p class="step-desc">
                    Skilled mechanics complete your repairs using <span
                        class="text-accent">quality parts</span
                    >. Every job is backed by our <span class="text-accent"
                        >24-month / 24,000-mile warranty</span
                    >. Get back on the road with confidence.
                </p>
            </div>
        </div>
    </div>
</section>

<style>
    .process-section {
        --section-bg: #fafafa;
        --card-bg: #ffffff;
        --card-border: rgba(0, 0, 0, 0.08);
        --text-primary: #0f172a;
        --text-secondary: #64748b;
        --accent: #0a79c8;
        --accent-light: rgba(10, 121, 200, 0.15);

        background: var(--section-bg);
        overflow: hidden;
        margin-bottom: -35vh; /* Pulls the section below up into this one */
        position: relative;
        z-index: 10;
    }

    :global(.dark) .process-section {
        --section-bg: #0a0a0b;
        --card-bg: rgba(255, 255, 255, 0.03);
        --card-border: rgba(255, 255, 255, 0.08);
        --text-primary: #f8fafc;
        --text-secondary: #94a3b8;
        --accent: #0a79c8;
        --accent-light: rgba(10, 121, 200, 0.15);
    }

    .process-container {
        display: grid;
        grid-template-columns: 1fr 80px 1.3fr;
        gap: 2rem;
        max-width: 1280px;
        margin: 0 auto;
        padding: 6rem 1.5rem;
    }

    /* Left Column - GSAP will pin this */
    .process-left {
        height: fit-content;
    }

    .process-title {
        color: var(--text-primary);
        margin: 0;
    }

    .title-accent {
        color: var(--accent);
    }

    .process-subtitle {
        font-size: 1rem;
        color: var(--text-secondary);
        line-height: 1.7;
        margin: 1.25rem 0 0;
    }

    .process-cta-container {
        margin-top: 2rem;
    }

    @media (max-width: 900px) {
        .process-cta-container {
            display: flex;
            justify-content: center;
        }
    }

    /* Middle: Progress Track - GSAP will pin this */
    .progress-track {
        height: fit-content;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2rem;
        visibility: hidden; /* Hide until GSAP is ready */
    }

    .progress-line {
        position: absolute;
        top: 10px;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 2px;
        background: var(--card-border);
        z-index: 0;
    }

    .progress-fill {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 0%; /* Start at 0, GSAP will animate it */
        background: var(--accent);
        transition: height 0.4s ease;
    }

    .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.375rem;
        position: relative;
        z-index: 1;
    }

    .step-dot {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: var(--section-bg);
        border: 2px solid var(--card-border);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        font-weight: 700;
        color: var(--text-secondary);
    }

    .progress-step.active .step-dot {
        background: var(--accent);
        border-color: var(--accent);
        box-shadow: 0 0 0 4px var(--accent-light);
        color: #ffffff;
    }

    /* Right Column: Cards - Scrollable */
    .process-right {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        padding-bottom: 5vh; /* Minimal buffer for the last card */
    }

    .step-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 1.25rem;
        padding: 2rem 2.5rem;
        transition: all 0.3s ease;
    }

    .step-card.active {
        border-color: rgba(10, 121, 200, 0.25);
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
    }

    :global(.dark) .step-card.active {
        border-color: rgba(10, 121, 200, 0.25);
    }

    .step-number {
        font-size: 2.5rem;
        font-weight: 300;
        color: var(--card-border);
        line-height: 1;
        display: block;
        margin-bottom: 0.75rem;
    }

    .step-card.active .step-number {
        color: var(--accent);
        opacity: 0.5;
    }

    .step-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0 0 0.5rem;
    }

    .step-desc {
        font-size: 0.9375rem;
        color: var(--text-secondary);
        line-height: 1.7;
        margin: 0;
    }

    .text-accent {
        color: var(--accent);
    }

    /* Responsive */
    @media (max-width: 900px) {
        .process-container {
            grid-template-columns: 60px 1fr;
            padding: 4rem 1rem;
        }

        .process-left {
            display: none;
        }

        .progress-track {
            visibility: visible; /* Make sure it's visible on mobile where GSAP isn't running */
        }
    }

    @media (max-width: 640px) {
        .process-container {
            grid-template-columns: 1fr;
        }

        .progress-track {
            display: none;
        }

        .step-card {
            padding: 1.5rem;
        }
    }
</style>

<script>
    import gsap from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";

    // Register globally once
    gsap.registerPlugin(ScrollTrigger);

    let ctx: any = null; // Keep track of GSAP context

    async function initProcessSection() {
        const section = document.getElementById("process-section");

        // Navigation cleanup if component is missing
        if (!section) {
            if (ctx) ctx.revert();
            return;
        }

        // Revert existing context
        if (ctx) ctx.revert();

        // Wait for next frame for layout stability
        await new Promise(requestAnimationFrame);

        // Don't run on mobile
        if (window.innerWidth <= 900) {
            // But ensure the progress fill is visible if we bail
            const progressFill = document.getElementById("progress-fill");
            if (progressFill) {
                gsap.set(progressFill, { height: "25%" });
            }
            return;
        }

        ctx = gsap.context(() => {
            const leftCol = section.querySelector(".process-left");
            const progressTrack = section.querySelector(".progress-track");
            const rightCol = section.querySelector(".process-right");
            const cards = section.querySelectorAll(".step-card");
            const progressSteps = section.querySelectorAll(".progress-step");
            const progressFill = document.getElementById("progress-fill");

            if (!leftCol || !progressTrack || !rightCol || cards.length === 0)
                return;

            // --- ENTRY ANIMATIONS ---

            // Animate left column elements (title, subtitle, CTA)
            const title = leftCol.querySelector(".process-title");
            const subtitle = leftCol.querySelector(".process-subtitle");
            const ctaContainer = leftCol.querySelector(
                ".process-cta-container",
            );
            const leftElements = [title, subtitle, ctaContainer].filter(
                Boolean,
            );

            if (leftElements.length > 0) {
                gsap.fromTo(
                    leftElements,
                    { y: -40, opacity: 0 },
                    {
                        y: 0,
                        opacity: 1,
                        stagger: 0.12,
                        duration: 0.8,
                        ease: "power2.out",
                        scrollTrigger: {
                            trigger: section,
                            start: "top 60%",
                            once: true,
                        },
                    },
                );
            }

            // Animate step cards with stagger
            if (cards.length > 0) {
                gsap.fromTo(
                    cards,
                    { x: 50, opacity: 0 },
                    {
                        x: 0,
                        opacity: 1,
                        stagger: 0.15,
                        duration: 0.7,
                        ease: "power2.out",
                        scrollTrigger: {
                            trigger: section,
                            start: "top 50%",
                            once: true,
                        },
                    },
                );
            }

            // --- EXISTING ANIMATIONS ---

            // 1. Fade in the whole progress track to prevent FOUC
            gsap.to(progressTrack, {
                visibility: "visible",
                duration: 0.5,
                delay: 0.2,
            });

            // 2. Set initial progress fill height
            gsap.set(progressFill, { height: "25%" });

            // 3. Pin the left column
            ScrollTrigger.create({
                trigger: leftCol,
                start: "top 120px",
                endTrigger: rightCol,
                end: "bottom bottom",
                pin: true,
                pinSpacing: false,
            });

            // 4. Pin the progress track
            ScrollTrigger.create({
                trigger: progressTrack,
                start: "top 120px",
                endTrigger: rightCol,
                end: "bottom bottom",
                pin: true,
                pinSpacing: false,
            });

            // 5. Update active card based on scroll
            cards.forEach((card, index) => {
                ScrollTrigger.create({
                    trigger: card,
                    start: "top 55%",
                    end: "bottom 45%",
                    onEnter: () => updateActiveStep(index),
                    onEnterBack: () => updateActiveStep(index),
                });
            });

            function updateActiveStep(index: number) {
                cards.forEach((c, i) =>
                    c.classList.toggle("active", i === index),
                );
                // This makes the dots active as you scroll past them
                progressSteps.forEach((s, i) =>
                    s.classList.toggle("active", i <= index),
                );
                if (progressFill) {
                    // Animate the fill line
                    gsap.to(progressFill, {
                        height: `${((index + 1) / cards.length) * 100}%`,
                        duration: 0.4,
                        ease: "power2.inOut",
                    });
                }
            }
        }, section); // Scope triggers to the section

        // Refresh after a short delay to account for dynamic content/fonts
        setTimeout(() => ScrollTrigger.refresh(), 500);
    }

    document.addEventListener("astro:page-load", initProcessSection);

    // Cleanup on unmount
    document.addEventListener("astro:before-swap", () => {
        if (ctx) ctx.revert();
    });
</script>
